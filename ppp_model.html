<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>M√¥ h√¨nh t√†i ch√≠nh PPP</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
<style>
:root {
  --primary:#667eea;
  --secondary:#764ba2;
  --danger:#e74c3c;
  --success:#27ae60;
  --light-bg:#f8f9fa;
  --text:#2c3e50;
}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--primary),var(--secondary));margin:0;padding:20px;color:var(--text);} 
.container{max-width:1200px;margin:auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.1);} 
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;} 
.tab-btn{flex:1 0 150px;padding:10px;border:none;border-radius:8px;background:var(--light-bg);cursor:pointer;font-weight:600;} 
.tab-btn.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;} 
.tab{display:none;} 
.tab.active{display:block;} 
input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;} 
label{font-weight:600;font-size:0.9rem;} 
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;} 
.table{width:100%;border-collapse:collapse;font-size:0.85rem;} 
.table th,.table td{border:1px solid #ddd;padding:6px;text-align:right;} 
.table th{background:var(--light-bg);} 
.metric{background:var(--light-bg);padding:12px;border-radius:8px;text-align:center;}
.metric h3{margin:4px 0;font-size:1.2rem;}
.status-good{color:var(--success);}
.status-bad{color:var(--danger);}
.dscr-good{color:var(--success);font-weight:600;}
.dscr-bad{color:var(--danger);font-weight:600;}
button.calculate{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;margin-top:10px;}
button.export{background:linear-gradient(135deg,var(--success),#2ecc71);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;}
@media(max-width:600px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="container">
  <h1>üèóÔ∏è M√¥ h√¨nh t√†i ch√≠nh PPP</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="assumptions">üìä Gi·∫£ ƒë·ªãnh</button>
    <button class="tab-btn" data-tab="cashflow">üí∞ D√≤ng ti·ªÅn</button>
    <button class="tab-btn" data-tab="analysis">üìà Ph√¢n t√≠ch</button>
    <button class="tab-btn" data-tab="sensitivity">üéØ ƒê·ªô nh·∫°y</button>
  </div>
  <div id="assumptions" class="tab active">
    <div class="grid">
      <div>
        <label>T·ªïng v·ªën ƒë·∫ßu t∆∞ (t·ª∑)</label>
        <input type="number" id="totalInvestment" value="5000" min="0" />
      </div>
      <div>
        <label>Th·ªùi gian d·ª± √°n (nƒÉm)</label>
        <input type="number" id="projectPeriod" value="20" min="1" />
      </div>
      <div>
        <label>T·ª∑ l·ªá v·ªën ch·ªß s·ªü h·ªØu (%)</label>
        <input type="number" id="equityRatio" value="30" min="0" max="100" />
      </div>
      <div>
        <label>L√£i su·∫•t vay (%/nƒÉm)</label>
        <input type="number" id="debtRate" value="8" step="0.1" />
      </div>
      <div>
        <label>Doanh thu nƒÉm 1 (t·ª∑)</label>
        <input type="number" id="initialRevenue" value="800" />
      </div>
      <div>
        <label>TƒÉng tr∆∞·ªüng doanh thu (%/nƒÉm)</label>
        <input type="number" id="revenueGrowth" value="3.5" step="0.1" />
      </div>
      <div>
        <label>B·∫£o tr√¨ (% doanh thu)</label>
        <input type="number" id="maintenanceCost" value="15" />
      </div>
      <div>
        <label>Nh√¢n s·ª± (% doanh thu)</label>
        <input type="number" id="staffCost" value="10" />
      </div>
      <div>
        <label>NƒÉng l∆∞·ª£ng (% doanh thu)</label>
        <input type="number" id="energyCost" value="10" />
      </div>
      <div>
        <label>L·∫°m ph√°t (%/nƒÉm)</label>
        <input type="number" id="inflation" value="3" step="0.1" />
      </div>
      <div>
        <label>T·ª∑ l·ªá chi·∫øt kh·∫•u (%/nƒÉm)</label>
        <input type="number" id="discountRate" value="10" step="0.1" />
      </div>
      <div>
        <label>Thu·∫ø TNDN (%)</label>
        <input type="number" id="taxRate" value="20" />
      </div>
      <div>
        <label>Th·ªùi gian kh·∫•u hao (nƒÉm)</label>
        <input type="number" id="depreciationPeriod" value="20" />
      </div>
    </div>
    <button class="calculate" onclick="calculateModel()">T√≠nh to√°n</button>
    <div id="quickResults" style="margin-top:20px;display:none;" class="grid"></div>
    <div id="controlPanel" style="margin-top:20px;display:none;">
      <h3>üéÆ Bu·ªìng l√°i m√¥ ph·ªèng</h3>
      <div class="grid">
        <div>
          <label>Bi·∫øn ƒë·ªông CAPEX (<span id="capexLabel">0%</span>)</label>
          <input type="range" id="capexSlider" min="-20" max="20" value="0" step="1" oninput="updateCapexLabel(this.value);runSimulation();" />
        </div>
        <div>
          <label>Bi·∫øn ƒë·ªông Doanh thu (<span id="revenueLabel">0%</span>)</label>
          <input type="range" id="revenueSlider" min="-15" max="15" value="0" step="1" oninput="updateRevenueLabel(this.value);runSimulation();" />
        </div>
        <div>
          <label>L√£i su·∫•t vay (%)</label>
          <input type="number" id="debtRateInput" value="8" step="0.1" oninput="runSimulation();" />
        </div>
        <div>
          <label>L·∫°m ph√°t (%)</label>
          <input type="number" id="inflationInput" value="3" step="0.1" oninput="runSimulation();" />
        </div>
      </div>
    </div>
  </div>

  <div id="cashflow" class="tab">
    <table class="table" id="cashflowTable">
      <thead>
        <tr>
          <th>NƒÉm</th>
          <th>Doanh thu</th>
          <th>Chi ph√≠</th>
          <th>EBITDA</th>
          <th>Kh·∫•u hao</th>
          <th>EBIT</th>
          <th>Thu·∫ø</th>
          <th>CF ho·∫°t ƒë·ªông</th>
          <th>Tr·∫£ n·ª£</th>
          <th>DSRA</th>
          <th>CF r√≤ng</th>
          <th>DSCR</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="analysis" class="tab">
    <div class="grid" id="analysisResults"></div>
    <canvas id="opexChart" style="max-height:300px;margin-top:20px;"></canvas>
  </div>

  <div id="sensitivity" class="tab">
    <button class="calculate" onclick="runSensitivity()">Ch·∫°y ph√¢n t√≠ch ƒë·ªô nh·∫°y</button>
    <div style="overflow-x:auto;margin-top:15px;">
      <table class="table" id="sensitivityTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div style="text-align:center;margin-top:20px;">
    <button class="export" onclick="exportExcel()">üìä Xu·∫•t Excel</button>
  </div>
</div>

<script>
// util functions
function irr(values, guess=0.1){
  let rate=guess;const max=1e4, eps=1e-7;for(let i=0;i<max;i++){let npv=0, dnpv=0;for(let t=0;t<values.length;t++){npv+=values[t]/Math.pow(1+rate,t);dnpv-=t*values[t]/Math.pow(1+rate,t+1);}const newRate=rate-npv/dnpv;if(Math.abs(newRate-rate)<=eps)return newRate;rate=newRate;}return rate;}

function npv(rate,values){let total=0;for(let t=0;t<values.length;t++)total+=values[t]/Math.pow(1+rate,t);return total;}

function getPayback(cashflows){let cum=0;for(let i=1;i<cashflows.length;i++){cum+=cashflows[i];if(cum>=-cashflows[0])return i;}return Infinity;}

function runFinancialModel(inp){
  const maint=inp.maintenance??0;
  const staff=inp.staff??0;
  const energy=inp.energy??0;
  const opRatio=inp.operatingCost??(maint+staff+energy);
  const debt=inp.totalInvestment*(1-inp.equityRatio);
  const annualDep=inp.totalInvestment/inp.depreciationPeriod;
  let remainingDebt=debt;const principal=debt/inp.projectPeriod;let cash=[-inp.totalInvestment];let ds=[];let table=[];
  let dsraBal=0;const dsraMonths=6;
  for(let y=1;y<=inp.projectPeriod;y++){
    const rev=inp.initialRevenue*Math.pow(1+inp.revenueGrowth,y-1);
    const cost=rev*opRatio*Math.pow(1+inp.inflation,y-1);
    const ebitda=rev-cost;
    const dep=y<=inp.depreciationPeriod?annualDep:0;
    const ebit=ebitda-dep;
    const tax=Math.max(0,ebit*inp.taxRate);
    const opCF=ebit-tax+dep;
    const interest=remainingDebt*inp.debtRate;
    const debtService=principal+interest;
    const dsraRequired=y===inp.projectPeriod?0:debtService*dsraMonths/12;
    const dsraChange=dsraRequired-dsraBal;
    dsraBal+=dsraChange;
    remainingDebt=Math.max(0,remainingDebt-principal);
    const net=opCF-debtService-dsraChange;
    cash.push(net);
    const dscr=debtService>0?opCF/debtService:0;ds.push(dscr);
    table.push({year:y,revenue:rev,opCost:cost,ebitda,dep,ebit,tax,opCF,debtService,dsraChange,net,dscr});
  }
  const npvVal=npv(inp.discountRate,cash);
  const irrVal=irr(cash);
  const payback=getPayback(cash);
  const avgDSCR=ds.reduce((a,b)=>a+b,0)/ds.length;
  const minDSCR=Math.min(...ds);
  return {npv:npvVal,irr:irrVal,payback,avgDSCR,minDSCR,cashflow:cash,table,dscrArr:ds,opexBreakdown:{maintenance:maint,staff,energy},operatingCost:opRatio};
}

function renderModel(res){
  const tbody=document.querySelector('#cashflowTable tbody');
  tbody.innerHTML='';
  res.table.forEach(r=>{
    const dscrClass=r.dscr>=1.2?'dscr-good':'dscr-bad';
    const row=`<tr><td>${r.year}</td><td>${r.revenue.toFixed(1)}</td><td>${r.opCost.toFixed(1)}</td><td>${r.ebitda.toFixed(1)}</td><td>${r.dep.toFixed(1)}</td><td>${r.ebit.toFixed(1)}</td><td>${r.tax.toFixed(1)}</td><td>${r.opCF.toFixed(1)}</td><td>${r.debtService.toFixed(1)}</td><td>${r.dsraChange.toFixed(1)}</td><td>${r.net.toFixed(1)}</td><td class='${dscrClass}'>${r.dscr.toFixed(2)}</td></tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
  const quick=document.getElementById('quickResults');
  quick.style.display='grid';
  quick.innerHTML=`
    <div class='metric'><h3>NPV</h3><div class='${res.npv>0?'status-good':'status-bad'}'>${res.npv.toFixed(1)}</div></div>
    <div class='metric'><h3>IRR</h3><div class='${res.irr>(window.currentInputs?window.currentInputs.discountRate:0)?'status-good':'status-bad'}'>${(res.irr*100).toFixed(2)}%</div></div>
    <div class='metric'><h3>DSCR TB</h3><div>${res.avgDSCR.toFixed(2)}</div></div>
    <div class='metric'><h3>Payback</h3><div>${res.payback.toFixed(1)} nƒÉm</div></div>`;
  const analysis=document.getElementById('analysisResults');
  analysis.innerHTML=`
    <div class='metric'><h3>NPV</h3><div class='${res.npv>0?'status-good':'status-bad'}'>${res.npv.toFixed(1)}</div></div>
    <div class='metric'><h3>IRR</h3><div>${(res.irr*100).toFixed(2)}%</div></div>
    <div class='metric'><h3>PI</h3><div>${((res.npv+(window.currentInputs?window.currentInputs.totalInvestment:0))/(window.currentInputs?window.currentInputs.totalInvestment:1)).toFixed(2)}</div></div>
    <div class='metric'><h3>DSCR min</h3><div>${res.minDSCR.toFixed(2)}</div></div>
    <div class='metric'><h3>DSCR avg</h3><div>${res.avgDSCR.toFixed(2)}</div></div>
    <div class='metric'><h3>Kh·∫£ thi</h3><div class='${res.npv>0&&res.irr>(window.currentInputs?window.currentInputs.discountRate:0)?'status-good':'status-bad'}'>${res.npv>0&&res.irr>(window.currentInputs?window.currentInputs.discountRate:0)?'C√≥':'Kh√¥ng'}</div></div>`;
  renderOpexChart(res.opexBreakdown);
  window.projectNPV=res.npv;window.projectIRR=res.irr;window.avgDSCR=res.avgDSCR;window.minDSCR=res.minDSCR;
}

let opexChart;
function renderOpexChart(data){
  const ctx=document.getElementById('opexChart').getContext('2d');
  const dataset=[data.maintenance*100,data.staff*100,data.energy*100];
  if(opexChart) opexChart.destroy();
  opexChart=new Chart(ctx,{type:'doughnut',data:{labels:['B·∫£o tr√¨','Nh√¢n s·ª±','NƒÉng l∆∞·ª£ng'],datasets:[{data:dataset,backgroundColor:['#3498db','#e74c3c','#f1c40f']}]},options:{plugins:{legend:{position:'bottom'}}}});
}

function getBaseInputs(){
  const maintenance=parseFloat(document.getElementById('maintenanceCost').value)/100;
  const staff=parseFloat(document.getElementById('staffCost').value)/100;
  const energy=parseFloat(document.getElementById('energyCost').value)/100;
  const operatingCost=maintenance+staff+energy;
  return {
    totalInvestment:parseFloat(document.getElementById('totalInvestment').value),
    projectPeriod:parseInt(document.getElementById('projectPeriod').value),
    equityRatio:parseFloat(document.getElementById('equityRatio').value)/100,
    debtRate:Math.max(0,parseFloat(document.getElementById('debtRate').value)/100),
    initialRevenue:parseFloat(document.getElementById('initialRevenue').value),
    revenueGrowth:parseFloat(document.getElementById('revenueGrowth').value)/100,
    maintenance,staff,energy,operatingCost,
    inflation:parseFloat(document.getElementById('inflation').value)/100,
    discountRate:parseFloat(document.getElementById('discountRate').value)/100,
    taxRate:parseFloat(document.getElementById('taxRate').value)/100,
    depreciationPeriod:parseInt(document.getElementById('depreciationPeriod').value)
  };
}

function calculateModel(){
  window.baseInputs=getBaseInputs();
  window.currentInputs={...window.baseInputs};
  const res=runFinancialModel(window.currentInputs);
  renderModel(res);
  document.getElementById('controlPanel').style.display='block';
}

function runSimulation(){
  if(!window.baseInputs)return;
  const capex=parseInt(document.getElementById('capexSlider').value)/100;
  const revenue=parseInt(document.getElementById('revenueSlider').value)/100;
  const debtRate=parseFloat(document.getElementById('debtRateInput').value)/100;
  const inflation=parseFloat(document.getElementById('inflationInput').value)/100;
  const inp={...window.baseInputs};
  inp.totalInvestment=window.baseInputs.totalInvestment*(1+capex);
  inp.initialRevenue=window.baseInputs.initialRevenue*(1+revenue);
  inp.debtRate=debtRate;
  inp.inflation=inflation;
  window.currentInputs=inp;
  const res=runFinancialModel(inp);
  renderModel(res);
}

function updateCapexLabel(v){document.getElementById('capexLabel').innerText=v+'%';}
function updateRevenueLabel(v){document.getElementById('revenueLabel').innerText=v+'%';}

function runSensitivity(){
  if(!window.baseInputs){alert('H√£y t√≠nh to√°n m√¥ h√¨nh tr∆∞·ªõc');return;}
  const vars=[
    {key:'initialRevenue',label:'Doanh thu ban ƒë·∫ßu'},
    {key:'revenueGrowth',label:'TƒÉng tr∆∞·ªüng doanh thu'},
    {key:'operatingCost',label:'Chi ph√≠ v·∫≠n h√†nh'},
    {key:'debtRate',label:'L√£i su·∫•t vay'},
    {key:'discountRate',label:'T·ª∑ l·ªá chi·∫øt kh·∫•u'}
  ];
  const steps=[];for(let p=-10;p<=10;p+=2.5)steps.push(p/100);
  const thead=document.querySelector('#sensitivityTable thead');
  const tbody=document.querySelector('#sensitivityTable tbody');
  thead.innerHTML='<tr><th>Bi·∫øn s·ªë</th>'+steps.map(s=>`<th>${(s*100).toFixed(1)}%</th>`).join('')+'</tr>';
  tbody.innerHTML='';
  vars.forEach(v=>{
    const row=[`<tr><td>${v.label}</td>`];
    steps.forEach(s=>{
      const modInputs={...window.baseInputs};
      modInputs[v.key]=modInputs[v.key]*(1+s);
      const res=runFinancialModel(modInputs);
      row.push(`<td>${res.npv.toFixed(0)}</td>`);
    });
    row.push('</tr>');
    tbody.insertAdjacentHTML('beforeend',row.join(''));
  });
}

function exportExcel(){
  if(!window.currentInputs){alert('T√≠nh to√°n m√¥ h√¨nh tr∆∞·ªõc');return;}
  const wb=XLSX.utils.book_new();
  const ass=[['Th√¥ng s·ªë','Gi√° tr·ªã'],
    ['T·ªïng v·ªën ƒë·∫ßu t∆∞',window.currentInputs.totalInvestment],
    ['Th·ªùi gian d·ª± √°n',window.currentInputs.projectPeriod],
    ['T·ª∑ l·ªá v·ªën ch·ªß s·ªü h·ªØu',window.currentInputs.equityRatio],
    ['L√£i su·∫•t vay',window.currentInputs.debtRate],
    ['Doanh thu nƒÉm 1',window.currentInputs.initialRevenue],
    ['TƒÉng tr∆∞·ªüng doanh thu',window.currentInputs.revenueGrowth],
    ['B·∫£o tr√¨',window.currentInputs.maintenance],
    ['Nh√¢n s·ª±',window.currentInputs.staff],
    ['NƒÉng l∆∞·ª£ng',window.currentInputs.energy],
    ['L·∫°m ph√°t',window.currentInputs.inflation],
    ['Chi·∫øt kh·∫•u',window.currentInputs.discountRate],
    ['Thu·∫ø',window.currentInputs.taxRate],
    ['Kh·∫•u hao',window.currentInputs.depreciationPeriod],
    ['NPV',window.projectNPV],
    ['IRR',window.projectIRR],
    ['DSCR TB',window.avgDSCR]
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ass),'Assumptions');
  const cfSheet=[['NƒÉm','Doanh thu','Chi ph√≠','EBITDA','Kh·∫•u hao','EBIT','Thu·∫ø','CF ho·∫°t ƒë·ªông','Tr·∫£ n·ª£','DSRA','CF r√≤ng','DSCR']];
  const rows=document.querySelectorAll('#cashflowTable tbody tr');
  rows.forEach(r=>{const cells=[...r.children].map(c=>c.innerText);cfSheet.push(cells);});
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cfSheet),'Cashflow');
  const sensSheet=[...document.querySelector('#sensitivityTable').rows].map(r=>[...r.cells].map(c=>c.innerText));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sensSheet),'Sensitivity');
  XLSX.writeFile(wb,'ppp_model.xlsx');
}

// tab switching
const tabBtns=document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn=>btn.addEventListener('click',()=>{tabBtns.forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');document.getElementById(btn.getAttribute('data-tab')).classList.add('active');}));
</script>
</body>
</html>
